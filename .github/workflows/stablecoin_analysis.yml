name: Stablecoin Analysis - All Jurisdictions

on:
  workflow_dispatch:  # Manual trigger
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours to continue from progress

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # ~6 hours max

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download previous progress
        uses: actions/download-artifact@v4
        with:
          name: analysis-progress
          path: stablecoin_analysis_all_jurisdictions/
        continue-on-error: true  # First run won't have artifacts

      - name: Run analysis
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          LANGSMITH_API_KEY: ${{ secrets.LANGSMITH_API_KEY }}
        run: |
          # Create auto-continue version of the script
          python -c "
          import sys
          sys.path.insert(0, '.')
          
          # Patch input to auto-continue
          import builtins
          original_input = builtins.input
          builtins.input = lambda x: 'yes'
          
          # Run the analysis
          exec(open('full_stablecoin_analysis_all_jurisdictions.py').read())
          "

      - name: Upload progress artifacts
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if job fails/times out
        with:
          name: analysis-progress
          path: stablecoin_analysis_all_jurisdictions/
          retention-days: 90

      - name: Upload summary to release
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-summary-${{ github.run_number }}
          path: |
            stablecoin_analysis_all_jurisdictions/FULL_ANALYSIS_SUMMARY.md
            stablecoin_analysis_all_jurisdictions/progress.json
          retention-days: 90

      - name: Check completion status
        run: |
          python -c "
          import json
          with open('stablecoin_analysis_all_jurisdictions/progress.json') as f:
              progress = json.load(f)
          completed = len(progress.get('completed', []))
          total = 257
          print(f'Progress: {completed}/{total} ({completed/total*100:.1f}%)')
          if completed >= total:
              print('✅ ANALYSIS COMPLETE!')
          else:
              print(f'⏳ {total - completed} jurisdictions remaining')
          "

